@model Projekt_BDwAI_Magazyn.Models.Order
@using Projekt_BDwAI_Magazyn.Models

@{
    ViewData["Title"] = "Szczegóły zamówienia";
}

<h1>@ViewData["Title"]</h1>

<div>
    <h4>Zamówienie #@Model.Id</h4>
    <hr />

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">
            @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">
            @TempData["ErrorMessage"]
        </div>
    }

    <dl class="row">
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Id)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Id)
        </dd>

        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.OrderDate)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.OrderDate)
        </dd>

        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Status)
        </dt>
        <dd class="col-sm-10">
            <span class="badge
                @(Model.Status == OrderStatus.New ? "bg-primary" :
                                    Model.Status == OrderStatus.Completed ? "bg-success" :
                                    Model.Status == OrderStatus.InProgress ? "bg-warning" :
                                    "bg-secondary")">
                @Html.DisplayFor(model => model.Status)
            </span>
        </dd>

        <dt class="col-sm-2">
            Klient
        </dt>
        <dd class="col-sm-10">
            @Model.User?.Email
        </dd>
    </dl>

    <h4>Pozycje zamówienia</h4>
    <table class="table">
        <thead>
            <tr>
                <th>Produkt</th>
                <th>SKU</th>
                <th>Ilość</th>
                <th>Cena jednostkowa</th>
                <th>Wartość</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.OrderItems)
            {
                <tr>
                    <td>@((item.Product as Product)?.Name)</td>
                    <td>@((item.Product as Product)?.Sku)</td>
                    <td>@item.Quantity</td>
                    <td>@item.UnitPrice.ToString("C")</td>
                    <td>@((item.Quantity * item.UnitPrice).ToString("C"))</td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <td colspan="4" class="text-end"><strong>Razem:</strong></td>
                <td><strong>@Model.OrderItems.Sum(oi => oi.Quantity * oi.UnitPrice).ToString("C")</strong></td>
            </tr>
        </tfoot>
    </table>
</div>

@if (User.IsInRole("Admin"))
{
    <div class="mt-4">
        @if (Model.Status == OrderStatus.New)
        {
            <form asp-action="Complete" method="post" class="d-inline">
                <input type="hidden" name="id" value="@Model.Id" />
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-success">Oznacz jako zrealizowane</button>
            </form>

            <form asp-action="Cancel" method="post" class="d-inline ms-2">
                <input type="hidden" name="id" value="@Model.Id" />
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-danger"
                        onclick="return confirm('Czy na pewno chcesz anulować to zamówienie? Produkty zostaną zwrócone do magazynu.');">
                    Anuluj zamówienie
                </button>
            </form>
        }
        else if (Model.Status == OrderStatus.Cancelled)
        {
            <div class="alert alert-secondary">
                To zamówienie zostało anulowane. Produkty zostały zwrócone do magazynu.
            </div>
        }
        else if (Model.Status == OrderStatus.Completed)
        {
            <div class="alert alert-success">
                To zamówienie zostało zrealizowane.
            </div>
        }
        else if (Model.Status == OrderStatus.InProgress)
        {
            <div class="alert alert-warning">
                To zamówienie jest w trakcie realizacji.
            </div>
        }
    </div>
}

<div class="mt-3">
    <a asp-action="Index" class="btn btn-secondary">Powrót do listy</a>
</div>